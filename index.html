<!DOCTYPE HTML>
<html>
<head>
	<title>Bees Vs Humans</title>
	<style>
	canvas 
	{
		border:1px black solid;
		position:absolute;
		top:0px;
		left:0px;
	}
</style>
<script src="bees.js"></script>
</head>
<body>	
</body>
</html>
<script>
	lawn = 
	{
		background:"green",
		numX:15,
		numY:10,
		rectWidth:80,
		rectHeight:80,
		lawn:[],
		fill:function(pole)
		{
			for(var i=0;i<this.numY;i++)
			{
				var helper=[];
				for(var j=0;j<this.numX;j++)
				{
					helper.push(0);
				}
				pole.push(helper);
			};
		},
		draw:function()
		{
			context.beginPath();
			context.rect(0, 0, this.numX*this.rectWidth, canvas.height);
			context.fillStyle = this.background;
			context.fill();
		}
	};
	
	sidebar=
	{
		background:"grey",
		draw:function()
		{
			
			/* Draw sidebar */
			context.beginPath();
			context.rect(lawn.numX*lawn.rectWidth, 0, 2.5*lawn.rectWidth, canvas.height);
			context.fillStyle = this.background;
			context.fill();

			/* Draw honey */
			context.font = 'italic 35pt Calibri';
			context.fillStyle = 'red';
			context.fillText("Level "+level, (lawn.numX*lawn.rectWidth+10), 45);
			
			context.font = 'italic 35pt Calibri';
			context.fillStyle = 'blue';
			context.fillText(honey+" H", (lawn.numX*lawn.rectWidth+10), 85);
			
			/* Draw bees */
			
			for(i in this.bees)
			{
				var curr = this.bees[i];
				curr.image.src="images/"+curr.img;								
				if(player.select[0]==curr.name)
				{
					context.beginPath();
					context.rect(curr.x, curr.y, lawn.rectWidth, lawn.rectHeight);
					context.fillStyle = '#444';
					context.fill();
				}
				context.drawImage(curr.image,curr.x,curr.y,lawn.rectWidth,lawn.rectHeight);
			}
		},
		bees:
		{
			0:
			{
				id:"a",
				image : new Image(),
				img: "honeycomb.png",				
				name:"honeycomb",
				x:1250,
				y:95,
				level: 1
			},
			1:
			{
				id:"b",
				image : new Image(),
				img: "honeybee.png",
				name:"honeybee",
				x:1250,
				y:95+90,
				level: 1
			},
			2:
			{
				id:"c",
				image : new Image(),
				img: "swarm.png",
				name:"swarm",
				x:1250,
				y:95+180,	
				level: 2
			}
			3:
			{
				id:"d",
				image : new Image(),
				img: "bumblebee.png",
				name:"bumblebee",
				x:1250,
				y:95+270,
				level: 3
			},
		}
	};
	
	player=
	{
		select:false
	};
	
	function init(l)
	{
		canvas= document.createElement("canvas");
		canvas.width=window.innerWidth;
		canvas.height=window.innerHeight;
		document.body.appendChild(canvas);
		context = canvas.getContext('2d');
		isPlaying=false;
		ticks = 0;
		honey = 100;
		level = l;
		lasthumanAdd=Date.now();
		firsthumanAdd=Date.now();
		isWave = false;
		isBreak = false;
		win = false;
		lose = false;
		humanspassed = 0;
		bees = [];
		humans = [];
		honeys = [];
		shots = [];
		lawn.fill(lawn.lawn);
	};

	function mainLoop()
	{

		check();
		seeder();
		draw();
		move();
		ticks++;
		if(isPlaying)
		{
			requestAnimationFrame(mainLoop);
		}
		if(win)
		{
			win = false;
			level += 1;
			init(level);
			mainLoop();
		}
	};

	function draw()
	{
		lawn.draw();
		for(i in bees)
		{
			bees[i].draw();
		}
		for(i in humans)
		{
			humans[i].draw();
		}
		for(i in shots)
		{
			shots[i].draw();
		}
		for(i in honeys)
		{
			honeys[i].draw();
		}
		sidebar.draw();
	};

	function move()
	{
		for(i in humans)
		{
			humans[i].move();
			if(humans[i].x<0)
			{
				humanspassed += 1;
				if(humanspassed>5)
				{
					init(level);
					mainLoop();
				}
			}
		}
		for(i in honeys)
		{
			honeys[i].move();
		}
		for(i in shots)
		{
			shots[i].move();
		}
	};		

	function check()
	{
		/*Check if bee shots or produce honey*/
		for(i in bees)
		{
			if(typeof(bees[i].checkGetingSun) === "function")
			{
				bees[i].checkGetingSun();
			}
			if(typeof(bees[i].checkShot) === "function")
			{
				bees[i].checkShot();
			}
		};
		i=0;
		/* Check honey time */
		for(i in honeys)
		{
			if(honeys[i].checkTime())
			{
				honeys.splice(i,1);
			}
		};
		i=0;
		/* Check if shot hit target */
		for(i in shots)
		{
			var curr=shots[i];	
			if(typeof(curr.checkColision) === "function"){		
				if(curr.checkColision())
				{
					shots.splice(i,1);
					continue;	
				}
			}
			if(typeof(curr.life) != "undefined")
			{
				if(curr.life<0)
				{
					curr.target.healt--;
					if(curr.target.healt<=0)
					{
						humans.splice(humans.indexOf(curr.target),1);
					}
					shots.splice(i,1);
					continue;	
				}
			}
			if(curr.x-curr.polomer>=lawn.numX*lawn.rectWidth)
			{
				shots.splice(i,1);
			}
		};
		i=0;
		for(i in humans)
		{
			humans[i].checkBite();
		};
	};

	function seeder()
	{
		if(humans.length == 0 && Date.now()-firsthumanAdd>=160000)
			win = true;
		if(isBreak && Date.now()-lasthumanAdd>=10000)
		{
			isBreak = false;
			lasthumanAdd=Date.now()-10000;
		}
		if(!isWave && Date.now()-firsthumanAdd>=150000)
			isWave = true;
		if(Date.now()-firsthumanAdd>=160000)
		{
			isWave = false;
			isBreak = true;
		}
		if(!isBreak && isWave && Date.now()-lasthumanAdd>=2000)
		{
			var riadok=Math.floor(Math.random()*10);
			humans.push(new caveman((lawn.numX*lawn.rectWidth+40),riadok*lawn.rectHeight));
			lasthumanAdd=Date.now();
		}
		else if(!isBreak && !isWave && Date.now()-lasthumanAdd>=10000)
		{
			var riadok=Math.floor(Math.random()*10);
			humans.push(new caveman((lawn.numX*lawn.rectWidth+40),riadok*lawn.rectHeight));
			lasthumanAdd=Date.now();
		}
	};

	function click(data)
	{

		/* If click in sidebar */

		for(j in sidebar.bees)
		{
			var curr=sidebar.bees[j];
			var X=data.clientX;
			var Y=data.clientY;
			var click=((X>curr.x)&&(X<curr.x+lawn.rectWidth)&&(Y>curr.y)&&(Y<curr.y+lawn.rectHeight));
			if(click)
			{
				if(player.select[0]==curr["name"])
				{
					player.select=false;
					break;
				}
				else
				{
					if(honey>=window[curr["name"]].prototype.cost)
					{
						player.select=[curr["name"],curr["id"]];
						break;
					}
				}
			}
		}

		/* If click in sun */

		for(i in honeys)
		{
			var curr=honeys[i];
			if(clickIn(X,Y,curr))
			{
				honey+=curr.honeyVal;
				honeys.splice(i,1);
				return true;
			}
		}

		/* If click in lawn */

		if((data.x>=0)&&(data.x<=lawn.numX*lawn.rectWidth)&&(data.y>=0)&&(data.y<=lawn.numY*lawn.rectHeight)&&(player.select))
		{
			var Xko=Math.floor(X/lawn.rectWidth);
			var Yko=Math.floor(Y/lawn.rectHeight);
			if(lawn.lawn[Yko][Xko]!=0)
			{
				return false;
			}
			bees.push(new window[player.select[0]](data.clientX,data.clientY));
			lawn.lawn[Yko][Xko]=player.select[1];
			player.select=false;			
		}
	};

	function colision(a,b)
	{
		if((b.x+b.width>a.x)&&
			(b.y+b.height>a.y)&&
			(b.x<a.x+a.width)&&
			(b.y<a.y+a.height))
		{
			return 1;
		}  
		return 0;
	};

	function clickIn(x,y,obj)
	{
		if((obj.x<x)&&(obj.x+obj.polomer*2>x)&&(obj.y<y)&&(obj.y+obj.polomer*2>y))
		{
			return 1;
		}
		return 0;
	};

	window.onclick=function(d)
	{
		click(d);
	};

	init(1);
	isPlaying=true;
	mainLoop();

</script>
